<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Map Selector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    #map { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
    /* Left-side always-expanded settings panel, theme-adaptive */
    .side-panel {
      position: absolute;
      top: 36px;
      left: 36px;
      z-index: 1002;
      background: var(--widget-bg, #fff);
      border-radius: 18px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.13);
      padding: 18px 14px 18px 14px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 18px;
      min-width: 180px;
      max-width: 260px;
      width: 220px;
      transition: none;
      backdrop-filter: blur(8px);
    }
    .panel-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
      align-items: flex-start;
    }
    .side-btn {
      border: none;
      background: none;
      color: var(--primary, #1976d2);
      border-radius: 10px;
      width: 100%;
      min-width: 120px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background 0.18s, color 0.18s;
      outline: none;
      position: relative;
      padding-left: 8px;
      gap: 10px;
    }
    .side-btn.selected, .side-btn:focus {
      background: var(--primary, #2196f3);
      color: var(--text-on-primary, #fff);
    }
    .side-btn.selected svg, .side-btn.selected .icon {
      color: var(--text-on-primary, #fff);
      fill: var(--text-on-primary, #fff);
    }
    .side-btn:hover {
      background: var(--accent, #e3f2fd);
      color: var(--primary-dark, #0d47a1);
    }
    .side-btn .tooltip {
      display: none;
    }
    .finish-btn {
      width: 100%;
      background: var(--success, #43a047);
      color: var(--text-on-primary, #fff);
      border: none;
      border-radius: 10px;
      padding: 10px 0;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(67,160,71,0.10);
      transition: background 0.18s, box-shadow 0.18s;
      outline: none;
      display: none;
      margin-top: 4px;
    }
    .finish-btn.show { display: block !important; }
    .finish-btn:focus, .finish-btn.selected {
      background: var(--primary-dark, #388e3c);
      box-shadow: 0 4px 16px rgba(67,160,71,0.13);
    }
    .finish-btn:hover {
      background: var(--accent, #2e7031);
    }
    .instructions {
      display: flex;
      align-items: center;
      gap: 0;
      color: var(--primary, #1976d2);
      font-size: 0.98rem;
      font-weight: 500;
      background: var(--accent, #e3f2fd);
      border-radius: 8px;
      padding: 7px 10px;
      box-shadow: 0 1px 2px rgba(33,150,243,0.06);
      min-height: 32px;
      width: 100%;
      margin-top: 8px;
      margin-bottom: 0;
      text-align: left;
    }
    .map-type-options-pop {
      position: absolute;
      left: 170px;
      top: 0;
      background: var(--widget-bg, #fff);
      border-radius: 10px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.13);
      padding: 8px 0;
      min-width: 140px;
      z-index: 1004;
      display: none;
      flex-direction: column;
      gap: 2px;
      backdrop-filter: blur(6px);
    }
    .map-type-options-pop.show { display: flex; }
    .map-type-option {
      padding: 8px 18px;
      cursor: pointer;
      font-size: 1rem;
      color: var(--primary, #1976d2);
      border: none;
      background: none;
      text-align: left;
      transition: background 0.18s, color 0.18s;
      border-radius: 8px;
      margin: 1px 0;
    }
    .map-type-option.selected, .map-type-option:hover {
      background: var(--accent, #e3f2fd);
      color: var(--primary-dark, #1976d2);
    }
    .leaflet-control-attribution {
      background: rgba(255,255,255,0.7) !important;
      color: #888 !important;
      font-size: 0.95rem !important;
      border-radius: 8px !important;
      margin: 0 8px 8px 0 !important;
      padding: 2px 10px !important;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }
    @media (max-width: 600px) {
      .side-panel { top: 8px; left: 8px; padding: 8px 2px 8px 2px; min-width: 80px; max-width: 99vw; width: 120px; }
      .side-btn { width: 32px; height: 32px; font-size: 1.1rem; }
      .finish-btn { font-size: 0.95rem; padding: 7px 0; }
      .instructions { font-size: 0.92rem; padding: 5px 6px; }
      .map-type-options-pop { left: 90px; min-width: 90px; }
    }
  </style>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <div id="map"></div>
  <div class="side-panel" tabindex="0">
    <div class="panel-group">
      <button class="side-btn selected" id="rectModeBtn" title="Rectangle Mode">&#9633; Rectangle</button>
      <button class="side-btn" id="polyModeBtn" title="Freeform Mode">&#11044; Freeform</button>
      <button class="side-btn" id="zoomInBtn" title="Zoom In">+ Zoom In</button>
      <button class="side-btn" id="zoomOutBtn" title="Zoom Out">‚àí Zoom Out</button>
      <button class="side-btn" id="mapTypeToggle" title="Switch Map Type">üó∫Ô∏è Map Type</button>
      <div class="map-type-options-pop" id="mapTypeOptions"></div>
      <button class="finish-btn" id="finishBtn" style="display:none;">&#10003; Finish</button>
    </div>
    <span class="instructions" id="instructions" style="display:none;"></span>
  </div>
  <script>
    // Use only 5 professional map types
    const mapTypes = [
      { name: 'OpenStreetMap', url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', attr: '¬© OSM contributors' },
      { name: 'Esri Satellite', url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', attr: '¬© Esri, Maxar' },
      { name: 'Esri Streets', url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', attr: '¬© Esri' },
      { name: 'CartoDB Voyager', url: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', attr: '¬© CartoDB' },
      { name: 'OpenTopoMap', url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', attr: '¬© OpenTopoMap' }
    ];
    let currentMapType = 0;
    // Initialize map
    const map = L.map('map', { preferCanvas: true }).setView([20, 0], 2);
    let tileLayer = L.tileLayer(mapTypes[0].url, { attribution: mapTypes[0].attr, maxZoom: 19, keepBuffer: 8 });
    tileLayer.addTo(map);
    // Remove default Leaflet zoom controls
    map.zoomControl.remove();
    // Custom zoom controls
    document.getElementById('zoomInBtn').onclick = () => map.zoomIn();
    document.getElementById('zoomOutBtn').onclick = () => map.zoomOut();
    // Minimal map type switcher
    const mapTypeToggle = document.getElementById('mapTypeToggle');
    const mapTypeOptions = document.getElementById('mapTypeOptions');
    let mapTypeMenuOpen = false;
    mapTypeToggle.onclick = (e) => {
      e.stopPropagation();
      mapTypeMenuOpen = !mapTypeMenuOpen;
      mapTypeOptions.classList.toggle('show', mapTypeMenuOpen);
    };
    document.body.addEventListener('click', () => {
      mapTypeMenuOpen = false;
      mapTypeOptions.classList.remove('show');
    });
    mapTypeOptions.onclick = (e) => e.stopPropagation();
    // Populate map type options
    mapTypes.forEach((type, idx) => {
      const btn = document.createElement('button');
      btn.className = 'map-type-option' + (idx === 0 ? ' selected' : '');
      btn.textContent = type.name;
      btn.onclick = () => {
        if (currentMapType !== idx) {
          map.removeLayer(tileLayer);
          tileLayer = L.tileLayer(type.url, { attribution: type.attr, maxZoom: 19, keepBuffer: 8 });
          tileLayer.addTo(map);
          document.querySelectorAll('.map-type-option').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          currentMapType = idx;
        }
        mapTypeMenuOpen = false;
        mapTypeOptions.classList.remove('show');
      };
      mapTypeOptions.appendChild(btn);
    });

    // --- Selection Modes ---
    let mode = 'rect'; // 'rect' or 'poly'
    let points = [];
    let tempLayer = null;
    let polyLayer = null;
    let rectLayer = null;
    const rectBtn = document.getElementById('rectModeBtn');
    const polyBtn = document.getElementById('polyModeBtn');
    const finishBtn = document.getElementById('finishBtn');
    const instructions = document.getElementById('instructions');

    function clearSelection() {
      points = [];
      if (tempLayer) { map.removeLayer(tempLayer); tempLayer = null; }
      if (polyLayer) { map.removeLayer(polyLayer); polyLayer = null; }
      if (rectLayer) { map.removeLayer(rectLayer); rectLayer = null; }
    }

    rectBtn.onclick = () => {
      mode = 'rect';
      rectBtn.classList.add('selected');
      polyBtn.classList.remove('selected');
      finishBtn.classList.remove('show');
      instructions.style.display = 'none';
      clearSelection();
    };
    polyBtn.onclick = () => {
      mode = 'poly';
      polyBtn.classList.add('selected');
      rectBtn.classList.remove('selected');
      finishBtn.classList.add('show');
      instructions.style.display = '';
      instructions.textContent = 'Click to add points. Click Finish when done.';
      clearSelection();
    };

    // Convex hull (Andrew's monotone chain, O(n log n))
    function convexHull(pts) {
      if (pts.length <= 3) return pts.slice();
      pts = pts.slice().sort((a, b) => a.lng - b.lng || a.lat - b.lat);
      const cross = (o, a, b) => (a.lng - o.lng) * (b.lat - o.lat) - (a.lat - o.lat) * (b.lng - o.lng);
      const lower = [];
      for (let p of pts) {
        while (lower.length >= 2 && cross(lower[lower.length-2], lower[lower.length-1], p) <= 0) lower.pop();
        lower.push(p);
      }
      const upper = [];
      for (let i = pts.length - 1; i >= 0; i--) {
        let p = pts[i];
        while (upper.length >= 2 && cross(upper[upper.length-2], upper[upper.length-1], p) <= 0) upper.pop();
        upper.push(p);
      }
      upper.pop(); lower.pop();
      return lower.concat(upper);
    }

    map.on('click', function(e) {
      if (mode === 'rect') {
        points.push(e.latlng);
        if (points.length === 2) {
          if (rectLayer) map.removeLayer(rectLayer);
          rectLayer = L.rectangle([points[0], points[1]], { color: '#1976d2', weight: 2, fillOpacity: 0.1 }).addTo(map);
          // Show popup to confirm
          rectLayer.bindPopup(`<div class='coords-popup'>Rectangle selected.<br><button id='select-rect-btn'>Select</button></div>`).openPopup();
          setTimeout(() => {
            const btn = document.getElementById('select-rect-btn');
            if (btn) {
              btn.onclick = () => {
                const coords = [points[0], points[1]];
                if (window.parent !== window) {
                  window.parent.postMessage({ type: 'map-rect', coords }, '*');
                } else if (window.electronAPI && window.electronAPI.sendCoords) {
                  window.electronAPI.sendCoords(coords);
                } else {
                  alert(`Rectangle: ${coords.map(c => `${c.lat},${c.lng}`).join(' | ')}`);
                }
              };
            }
          }, 100);
        } else if (points.length > 2) {
          clearSelection();
        }
      } else if (mode === 'poly') {
        points.push(e.latlng);
        // Always draw convex hull
        const hull = convexHull(points);
        if (polyLayer) map.removeLayer(polyLayer);
        polyLayer = L.polygon(hull, { color: '#43a047', weight: 2, fillOpacity: 0.15 }).addTo(map);
      }
    });

    finishBtn.onclick = () => {
      if (mode === 'poly' && points.length >= 3) {
        const hull = convexHull(points);
        if (window.parent !== window) {
          window.parent.postMessage({ type: 'map-poly', coords: hull }, '*');
        } else if (window.electronAPI && window.electronAPI.sendCoords) {
          window.electronAPI.sendCoords(hull);
        } else {
          alert('Polygon: ' + hull.map(c => `${c.lat},${c.lng}`).join(' | '));
        }
      }
    };

    // Note: For true offline caching, consider a service worker or a plugin like leaflet.offline in the future.
  </script>
</body>
</html> 